---
title: "Cache in Singleton Registry"
date: 2023-03-02T09:05:52+08:00
draft: false
---
== Spring单例注册器中的三级缓存

spring容器有个标志位，是否允许循环依赖:allowCircularReferences。如果此标志开启，当创建一个单例bean的时候,spring会将原始的bean放到 singletonFactories 中。用于可能的循环依赖。

[quote, source code of springframework]
"Eagerly caching bean '${beanName}' to allow for resolving potential circular references"

singletonFactories是一个键为beanName，值为ObjectFactory的HashMap。可以通过以下方法添加：

----
org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#addSingletonFactory
----

这个方法是一个protected方法,目前只有在 `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean` 方法中进行了调用。
`AbstractAutowireCapableBeanFactory` 会将 `getEarlyBeanReference` 函数指针传递给 `ObjectFactory` ，只有发生循环依赖时，才会去调用 `getObject` ，从而调用 `getEarlyBeanReference` 方法。如果这时在beanFactory中有 `SmartInstantiationAwareBeanPostProcessor` ,会调用这个bpp的 getEarlyBeanReference 方法，否则返回原始的bean。

其中我们最常用使用的是
